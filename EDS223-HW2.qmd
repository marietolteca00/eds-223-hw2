---
title: "EDS-223:Exploring Patterns of Environmental Justice"
Author: "Marie Tolteca"
format: html
editor: 
  markdown: 
    wrap: 72
---

## Learning outcomes

-   Build effective, responsible, accessible and aesthetically-pleasing
    maps

-   Practice manipulating vector and raster data to build multi-layer
    maps

-   Practice making maps in R, specifically using tmap

-   ST_JOIN: combines information, taking in the highest order of
    geometry (points, polygon,) will change and dataframe spatially
    enabled- they now have geometries, they both still have dataframe

#### Loading Packages/ Libaries Needed for this assignment

```{r}
library(tidyverse)
library(tmap)
library(here)
library(sf)
library(spData)
library(kableExtra)
library(patchwork)
```

#### Reading in Data- Downloaded

```{r}
# `here()` starts at /Users/marietolteca/Documents/MEDS/EDS-223L/EDS223-HW
here()

ej_df <- st_read(here('data','ejscreen','EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb'))

birds <- st_read(here('data/gbif-birds-LA/gbif-birds-LA.shp'))

HOLC <- st_read(here('data/mapping-inequality/mapping-inequality-los-angeles.json'))
```

#### Filtering EJ screen data to only LA

```{r}
# subset to the features in Cantebury
la_ej<- ej_df %>%
  filter(CNTY_NAME == "Los Angeles County") # define the topological relationship
```

## Part 1: Legacy of redlining in current environmental (in)justice

Your first task is to explore historical redlining in Los Angeles and
its legacy on present-day environmental justice. - Description For this
assignment, you must complete the following:

#### Data Exploration

```{r}
# Viewing Class and Geometry Type
class(birds)
unique(st_geometry_type(birds))
names(birds)
#head(birds) # Viewing fist 5 rows of data

class(la_ej)
unique(st_geometry_type(la_ej))
names(la_ej)
#head(df)

class(HOLC)
unique(st_geometry_type(HOLC))
names(HOLC)

st_crs(birds) #   User input: WGS 84 

st_crs(HOLC) #  User input: WGS 84 

st_crs(la_ej) #  User input: WGS 84 / Pseudo-Mercator 

#head(map_in)
```

#### CRS Transformation :

```{r}
# Checking transformation
if(st_crs(la_ej) != st_crs(birds)){
  warning("coordinate reference systems do not match :(")
}

# Transformation
birds <- st_transform(birds, crs = st_crs(la_ej))

# Checking if transformation worked 
if(st_crs(la_ej) == st_crs(birds)){
  warning("coordinate reference systems MATCH :)")
}
```

```{r}
if(st_crs(la_ej) != st_crs(HOLC)){
  warning("coordinate reference systems do not match :(")
}

HOLC_in <- st_transform(HOLC, crs = st_crs(la_ej))

if(st_crs(la_ej) == st_crs(HOLC)){
  warning("coordinate reference systems MATCH :)")
}
```

# Create a map of historical redlining neighborhoods, including:

neighborhoods colored by HOLC grade an appropriate base map a clear
title and legend

```{r}
# EJ screen- add the polygons to shape the rest of the area
tm_shape(la_ej)+
  tm_polygons()+
tm_shape(HOLC_in,
         # Plot mapping inequalities last, but set as main shape
         is.main =TRUE) + 
  tm_polygons(fill = "grade",
              fill.legend = tm_legend("HOLC Grade"))+
  tm_compass(position = c("left","bottom")) +
  tm_scalebar(position = c("right", "bottom")) +
  tm_title("Historical Redlining Neighborhoods by Grade")+
  tm_basemap("Esri.WorldTopoMap")
  
```

# Table Summarizing Percent of block groups within each Holc Grade:

The percentage of census block groups that fall within each HOLC grade
Also include the percent of census black groups that don’t fall within a
HOLC grade

```{r}
# Combining Data mapping inequalities and EJ screen data
HOLC_laej_join <- st_join(la_ej, HOLC_in, join = st_intersects) #HOLC_in has grade column check `HOLC_in$g`

# Creating Table
table_summary <- HOLC_laej_join %>%
  #filter(!is.na(grade)) %>%
  group_by(grade) %>%
  summarize(HOLCareas_by_grade = n()) %>% # Creates new column
  mutate(percentage = round(HOLCareas_by_grade / sum(HOLCareas_by_grade) * 100, 3)) %>%
  arrange() %>%
  st_drop_geometry() %>% 
  ungroup() %>% 
  kable(col.names = c("Grade","HOLC Acrea By Grade","Percentage")) %>%
  kable_minimal()



#Viewing Table
table_summary
```

# Create at least two visualizations summarizing current conditions (from the EJScreen data) within HOLC grades using the mean of the following variables (you may combine variables or create separate plots):

\% low income percentile for Particulate Matter 2.5 percentile for low
life expectancy Use **ggplot for your visualizations**! You will first
need to calculate mean of each variable grouped by HOLC grade.

```{r}
# Calculating Means
mean_HOLC <- HOLC_laej_join %>% 
  filter(!is.na(grade)) %>% # Drops NA values
  group_by(grade) %>% 
  summarize(mean_LWIN = mean(LOWINCOME),
            mean_PM25 = mean(P_PM25, na.rm=TRUE),
            mean_LE = mean(LIFEEXPPCT, na.rm=TRUE)
            )
# PLOTS
# Percentile of Low Income
low_income_plot <- ggplot(data = mean_HOLC, aes(x=grade, y=mean_LWIN, fill=grade))+
  geom_col()+
  # Adding colors to grade
  scale_fill_manual(values = c(
    "A" = "darkgoldenrod",
    "B" = "lightsalmon",
    "C" = "steelblue",
    "D" = "grey")) +
  labs(fill = "Grade",
       y = "Mean Particulate of Low Income",
       x = "",
       title= "Current Average Conditions by HOLC Grade")+
  theme_light()

# Percentile of Particulate Matter 2.5
PM25_plot <- ggplot(data = mean_HOLC, aes(x=grade, y=mean_PM25, fill = grade))+
  geom_col()+
   scale_fill_manual(values = c(
    "A" = "darkgoldenrod",
    "B" = "lightsalmon",
    "C" = "steelblue",
    "D" = "grey")) +
  labs(fill = "Grade",
       y = "Mean of Particulate Matter 2.5",
       x = "Grade")+
  theme_light()

# Percentile of Life Expectancy
life_plot<- ggplot(data = mean_HOLC, aes(x=grade, y=mean_LE, fill = grade))+
  geom_col()+
   scale_fill_manual(values = c(
    "A" = "darkgoldenrod",
    "B" = "lightsalmon",
    "C" = "steelblue",
    "D" = "grey")) +
  labs(fill = "Grade",
       y = "Mean Percentile of Life Expectancy",
       x = "")+
  theme_light()

# Combining 3-plots together
(low_income_plot+PM25_plot+life_plot)
#+ theme_legend(legend.position = "bottom")

```

### Reflection on results

-   Interpret the patterns you observe in your results
-   Discuss potential relationships between historical redlining grades
    and current environmental/socioeconomic conditions The plots show
    clear and consistent trends between historical HOLC grades and
    present-day environmental and socioeconomic conditions.
    Neighborhoods with worse historical grades (C and D) tend to have
    higher proportions of low-income residents and higher particulate
    matter (PM2.5) levels, indicating greater exposure to air pollution.
    On the other hand, previously rated as more favorable (A and B)
    places typically have higher life expectancy and lower pollution
    levels, indicating better overall health results. These trends are a
    reflection of redlining's long-term effects, as inequality in
    economic and environmental well-being is still shaped by
    disinvestment in lower-graded districts.

### Part 2: Legacy of redlining in biodiversity observations Your second

task is to explore the legacy of historical redlining in Los Angeles on
the collection of bird observations.

#### Description

For this assignment, you must produce the following based on
observations from 2021-2023:

```{r}
# Checking Year Column
unique(birds)
```

#### A figure summarizing the percent of observations *within* redlined neighborhoods within each HOLC grade

##### Create a visualizations that shows:

The **percentage of bird observations within each HOLC grade** Include
an appropiate title, axis labels, and legend Hints: Ensure the bird
observations and HOLC dataset have matching CRS’, then perform a spatial
join to assign each bird observations to a corresponding HOLC grade.

```{r}
#bird_grade <- st_join(birds, HOLC_laej_join, join = st_within)
bird_grade2 <- st_join(birds, HOLC_in, join = st_within)

bird_summ <- bird_grade2 %>% 
  filter(!is.na(grade)) %>% 
  group_by(grade) %>% 
  summarize(bird_obs_grade = n()) %>% 
  ungroup() %>% 
  mutate(bird_perc = bird_obs_grade/sum(bird_obs_grade, na.rm=TRUE)) 

```

### Plot it

```{r}
ggplot(data = bird_summ, aes(x=grade, y=bird_perc, fill = grade))+
  geom_col()+
   scale_fill_manual(values = c(
    "A" = "darkgoldenrod",
    "B" = "lightsalmon",
    "C" = "steelblue",
    "D" = "grey")) +
  labs(fill = "Grade",
       y = "birds",
       x = "")+
  theme_light()


```

# *Spolier alert!!* Our results don’t match the findings from Ellis-Soto et al. 2023! Read the abstract of the study. Why might we have obtained different results in our analysis? What did the paper consider that we did not?
